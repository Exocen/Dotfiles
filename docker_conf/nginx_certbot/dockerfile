FROM alpine:latest
ARG DOMAIN

VOLUME /etc/letsencrypt/
EXPOSE 80/TCP 443/TCP

RUN apk add python3 python3-dev py3-pip build-base libressl-dev musl-dev libffi-dev rust cargo
RUN pip3 install pip --upgrade
RUN pip3 install certbot-nginx
RUN mkdir /etc/letsencrypt

WORKDIR /root/
COPY docker-entrypoint.sh nginx.conf healthcheck.sh /root/
RUN find . -type f -print0 | xargs -0 sed -i 's/\[DOMAIN\]/'$DOMAIN'/g'
RUN /bin/sh -c "chmod +x *.sh"

HEALTHCHECK CMD ./healthcheck.sh

ENTRYPOINT ["/root/docker-entrypoint.sh"]
